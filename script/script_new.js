const buttons = {
  Backquote: {
    ru: ['ё', 'Ё'],
    en: ['`', '~'],
  },
  Digit1: {
    ru: ['1', '!'],
    en: ['1', '!'],
  },
  Digit2: {
    ru: ['2', '"'],
    en: ['2', '@'],
  },
  Digit3: {
    ru: ['3', '№'],
    en: ['3', '#'],
  },
  Digit4: {
    ru: ['4', ';'],
    en: ['4', '$'],
  },
  Digit5: {
    ru: ['5', '%'],
    en: ['5', '%'],
  },
  Digit6: {
    ru: ['6', ':'],
    en: ['6', '^'],
  },
  Digit7: {
    ru: ['7', '?'],
    en: ['7', '&'],
  },
  Digit8: {
    ru: ['8', '*'],
    en: ['8', '*'],
  },
  Digit9: {
    ru: ['9', '('],
    en: ['9', '('],
  },
  Digit0: {
    ru: ['0', ')'],
    en: ['0', ')'],
  },
  Minus: {
    ru: ['-', '_'],
    en: ['-', '_'],
  },
  Equal: {
    ru: ['=', '+'],
    en: ['=', '+'],
  },
  Backspace: {
    ru: ['Backspace', 'Backspace'],
    en: ['Backspace', 'Backspace'],
  },
  Tab: {
    ru: ['Tab', 'Tab'],
    en: ['Tab', 'Tab'],
  },
  KeyQ: {
    ru: ['й', 'Й'],
    en: ['q', 'Q'],
  },
  KeyW: {
    ru: ['ц', 'Ц'],
    en: ['w', 'W'],
  },
  KeyE: {
    ru: ['у', 'У'],
    en: ['e', 'E'],
  },
  KeyR: {
    ru: ['к', 'К'],
    en: ['r', 'R'],
  },
  KeyT: {
    ru: ['е', 'Е'],
    en: ['t', 'T'],
  },
  KeyY: {
    ru: ['н', 'Н'],
    en: ['y', 'Y'],
  },
  KeyU: {
    ru: ['г', 'Г'],
    en: ['u', 'U'],
  },
  KeyI: {
    ru: ['ш', 'Ш'],
    en: ['i', 'I'],
  },
  KeyO: {
    ru: ['щ', 'Щ'],
    en: ['o', 'O'],
  },
  KeyP: {
    ru: ['з', 'З'],
    en: ['p', 'P'],
  },
  BracketLeft: {
    ru: ['х', 'Х'],
    en: ['[', '{'],
  },
  BracketRight: {
    ru: ['ъ', 'Ъ'],
    en: [']', '}'],
  },
  Backslash: {
    ru: ['\\', '/'],
    en: ['\\', '|'],
  },
  Delete: {
    ru: ['Del', 'Del'],
    en: ['Del', 'Del'],
  },
  CapsLock: {
    ru: ['CapsLock', 'CapsLock'],
    en: ['CapsLock', 'CapsLock'],
  },
  KeyA: {
    ru: ['ф', 'Ф'],
    en: ['a', 'A'],
  },
  KeyS: {
    ru: ['ы', 'Ы'],
    en: ['s', 'S'],
  },
  KeyD: {
    ru: ['в', 'В'],
    en: ['d', 'D'],
  },
  KeyF: {
    ru: ['а', 'А'],
    en: ['f', 'F'],
  },
  KeyG: {
    ru: ['п', 'П'],
    en: ['g', 'G'],
  },
  KeyH: {
    ru: ['р', 'Р'],
    en: ['h', 'H'],
  },
  KeyJ: {
    ru: ['о', 'О'],
    en: ['j', 'J'],
  },
  KeyK: {
    ru: ['л', 'Л'],
    en: ['k', 'K'],
  },
  KeyL: {
    ru: ['д', 'Д'],
    en: ['l', 'L'],
  },
  Semicolon: {
    ru: ['ж', 'Ж'],
    en: [';', ':'],
  },
  Quote: {
    ru: ['э', 'Э'],
    en: ["'", '"'],
  },
  Enter: {
    ru: ['Enter', 'Enter'],
    en: ['Enter', 'Enter'],
  },
  ShiftLeft: {
    ru: ['Shift', 'Shift'],
    en: ['Shift', 'Shift'],
  },
  KeyZ: {
    ru: ['я', 'Я'],
    en: ['z', 'Z'],
  },
  KeyX: {
    ru: ['ч', 'Ч'],
    en: ['x', 'X'],
  },
  KeyC: {
    ru: ['с', 'С'],
    en: ['c', 'C'],
  },
  KeyV: {
    ru: ['м', 'М'],
    en: ['v', 'V'],
  },
  KeyB: {
    ru: ['и', 'И'],
    en: ['b', 'B'],
  },
  KeyN: {
    ru: ['т', 'Т'],
    en: ['n', 'N'],
  },
  KeyM: {
    ru: ['ь', 'Ь'],
    en: ['m', 'M'],
  },
  Comma: {
    ru: ['б', 'Б'],
    en: [',', '<'],
  },
  Period: {
    ru: ['ю', 'Ю'],
    en: ['.', '>'],
  },
  Slash: {
    ru: ['.', ','],
    en: ['/', '?'],
  },
  ArrowUp: {
    ru: ['▲', '▲'],
    en: ['▲', '▲'],
  },
  ShiftRight: {
    ru: ['Shift', 'Shift'],
    en: ['Shift', 'Shift'],
  },
  ControlLeft: {
    ru: ['Ctrl', 'Ctrl'],
    en: ['Ctrl', 'Ctrl'],
  },
  MetaLeft: {
    ru: ['Win', 'Win'],
    en: ['Win', 'Win'],
  },
  AltLeft: {
    ru: ['Alt', 'Alt'],
    en: ['Alt', 'Alt'],
  },
  Space: {
    ru: [' ', ' '],
    en: [' ', ' '],
  },
  AltRight: {
    ru: ['Alt', 'Alt'],
    en: ['Alt', 'Alt'],
  },
  ArrowLeft: {
    ru: ['◄', '◄'],
    en: ['◄', '◄'],
  },
  ArrowDown: {
    ru: ['▼', '▼'],
    en: ['▼', '▼'],
  },
  ArrowRight: {
    ru: ['►', '►'],
    en: ['►', '►'],
  },
  ControlRight: {
    ru: ['Ctrl', 'Ctrl'],
    en: ['Ctrl', 'Ctrl'],
  },
};

const createElement = (elType, elClassList, elInnerText) => {
  const newElem = document.createElement(elType);
  newElem.innerText = elInnerText || '';
  if (elClassList) newElem.classList.add(...elClassList);
  return newElem;
};
function createPage() {
  page.innerHTML = '';
  page.appendChild(createElement('p', ['title'], 'RSS Виртуальная клавиатура'));
  page.appendChild(textArea);
  const keyboard = creteKeyboard();
  page.appendChild(keyboard);
  page.appendChild(createElement('p', ['description'], 'Клавиатура создана в операционной системе Windows'));
  page.appendChild(createElement('p', ['language'], 'Для переключения языка комбинация: левыe ctrl + alt'));
  document.body.appendChild(page);
  keyNodes = Array.from(document.querySelectorAll('.key'));
}

function creteKeyboard() {
  const keyboard = createElement('div', ['body--keyboard', 'keyboard']);
  keyboard.id = 'keyboard';
  keyboard.appendChild(createRow(0, 14));
  keyboard.appendChild(createRow(14, 29));
  keyboard.appendChild(createRow(29, 42));
  keyboard.appendChild(createRow(42, 55));
  keyboard.appendChild(createRow(55, 64));
  return keyboard;
}
function createRow(start, finish) {
  const row = createElement('div', ['keyboard--row', 'row']);
  Object.keys(buttons)
    .slice(start, finish)
    .forEach((key) => {
      row.appendChild(createKey(key));
    });
  return row;
}
function createKey(key) {
  const keyButoon = createElement('div', ['keyboard--key', 'key', key]);
  keyButoon.appendChild(createKeylang('ru', key, language === 'en'));
  keyButoon.appendChild(createKeylang('en', key, language !== 'en'));
  return keyButoon;
}
function createKeylang(lang, key, hidden) {
  const keyButoon = hidden
    ? createElement('span', [lang, 'hidden'])
    : createElement('span', [lang]);
  const keyValue = buttons[key][lang];
  if (hidden) keyButoon.appendChild(createElement('span', ['caseDown', 'hidden'], keyValue[0]));
  else keyButoon.appendChild(createElement('span', ['caseDown'], keyValue[0]));
  keyButoon.appendChild(createElement('span', ['caseUp', 'hidden'], keyValue[1]));
  keyButoon.appendChild(createElement('span', ['caps', 'hidden'], keyValue[1]));
  keyButoon.appendChild(createElement('span', ['shiftCaps', 'hidden'], keyValue[0]));
  return keyButoon;
}
function changeLang(e) {
  if (e.ctrlKey && e.altKey) {
    language = language === 'en' ? 'ru' : 'en';
    localStorage.setItem('language', language);
    createPage();
  }
}
function keyStrokeHandler(e) {
  document.getElementsByClassName(e.code)[0].classList.add('active');
  if (e.code === 'ShiftRight' || e.code === 'ShiftLeft') {
    capsLock();
  } else if (e.code === 'CapsLock') {
    capsLock();
    if (!isCapsLock) document.getElementsByClassName('CapsLock')[0].classList.remove('active');
  } else if (e.code === 'AltLeft' || e.code === 'AltRight' || e.code === 'ControlLeft' || e.code === 'ControlRight') {
    changeLang(e);
  } else if (e.code === 'Backspace') {
    backspace();
  } else if (e.code === 'Delete') {
    deleteChar();
  } else if (e.code === 'Tab' || e.code === 'Enter' || e.code === 'Space') {
    insertSpaces(e);
  } else {
    modifyTextArea();
  }
}
function keyUpHandler(e) {
  if (e.code !== 'CapsLock') { document.getElementsByClassName(e.code)[0].classList.remove('active'); }
  if (e.code === 'ShiftRight' || e.code === 'ShiftLeft') {
    capsLock();
  }
}
function backspace() {
  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  textArea.value = textArea.value.slice(0, start === end
    ? start - 1 : start) + textArea.value.slice(end);

  textArea.selectionStart = start === end ? start - 1 : start;
  textArea.selectionEnd = textArea.selectionStart;
}
function deleteChar() {
  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  if (!(textArea.value.length > end)) return;

  textArea.value = textArea.value.slice(0, start) + textArea.value.slice(end + 1);
  textArea.selectionStart = start;
  textArea.selectionEnd = textArea.selectionStart;
}
function insertSpaces(e) {
  let space;
  if (e.code === 'Tab') space = '\t';
  if (e.code === 'Enter') space = '\n';
  if (e.code === 'Space') space = ' ';

  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  textArea.value = textArea.value.slice(0, start) + space + textArea.value.slice(end);

  textArea.selectionStart = start + 1;
  textArea.selectionEnd = textArea.selectionStart;
}
function modifyTextArea() {
  let char = '';
  keyNodes.forEach((elem) => {
    const classListArray = [...elem.classList];
    if (classListArray.indexOf('active') !== -1
    && classListArray.every((el) => ['ShiftRight', 'ShiftLeft', 'CapsLock', 'AltLeft', 'AltRight',
      'ControlLeft', 'ControlRight', 'Backspace', 'Delete'].indexOf(el) === -1)) {
      char = elem.querySelector('span:not(.hidden)>span:not(.hidden)').textContent;
    }
  });

  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;
  textArea.value = textArea.value.slice(0, start) + char + textArea.value.slice(end);

  textArea.selectionStart = start + 1;
  textArea.selectionEnd = textArea.selectionStart;
}
function capsLock() {
  isCapsLock = !isCapsLock;
  keyNodes.forEach((key) => {
    if (isCapsLock) {
      key.querySelectorAll('span:not(.hidden)>span:not(.hidden)').forEach((el) => el.classList.add('hidden'));
      key.querySelectorAll('span:not(.hidden)>span.caps').forEach((el) => el.classList.remove('hidden'));
    } else {
      key.querySelectorAll('span:not(.hidden)>span:not(.hidden)').forEach((el) => el.classList.add('hidden'));
      key.querySelectorAll('span:not(.hidden)>span.caseDown').forEach((el) => el.classList.remove('hidden'));
    }
  });
}

document.body.addEventListener('keydown', (e) => {
  if (keysArray.indexOf(e.code) > -1) {
    e.preventDefault();
    keyStrokeHandler(e);
  }
});
document.body.addEventListener('keyup', (e) => {
  if (keysArray.indexOf(e.code) > -1) {
    e.preventDefault();
    keyUpHandler(e);
  }
});
document.body.addEventListener('mousedown', (e) => {
  if (e.target.parentNode.parentNode !== undefined) {
    const eClassList = [...e.target.parentNode.parentNode.classList];
    document.body.dispatchEvent(new KeyboardEvent('keydown', { code: eClassList[eClassList.length - 1] }));
    if (document.getElementsByClassName(eClassList[eClassList.length - 1])[0]) document.getElementsByClassName(eClassList[eClassList.length - 1])[0].classList.remove('active');
  }
});
document.body.addEventListener('mouseup', (e) => {
  const eClassList = [...e.target.parentNode.parentNode.classList];
  document.body.dispatchEvent(new KeyboardEvent('keyup', { code: eClassList[eClassList.length - 1] }));
});

let language = localStorage.getItem('language') ? localStorage.getItem('language') : 'en';
localStorage.setItem('language', language);
let isCapsLock = false;
const keysArray = Object.keys(buttons);

const page = createElement('div', ['centralizer']);
const textArea = createElement('textarea', ['body--textarea', 'textarea']);
textArea.id = 'textarea';
textArea.setAttribute('rows', 5);
textArea.setAttribute('cols', 50);
let keyNodes;

createPage();
setInterval(() => {
  textArea.focus();
}, 0);
